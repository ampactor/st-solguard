[
  {
    "title": "PDA Bump Seed Not Stored/Verified in Initialize Instruction",
    "severity": "Medium",
    "description": "The initialize instruction derives PDAs for state and vault accounts using find_program_address but does not store or verify the bump seeds. This allows an attacker to potentially re-derive these PDAs with different bumps if they can control the seed inputs.",
    "file_path": "shielded_pool_program/src/instructions/initialize.rs",
    "line_number": 0,
    "remediation": "Store the canonical bump values in the state account data and verify them in all instructions using seeds + stored_bump instead of re-deriving."
  },
  {
    "title": "PDA Bump Seed Not Stored/Verified in Deposit Instruction",
    "severity": "Medium",
    "description": "The deposit instruction verifies the state and vault PDAs by re-deriving them but does not store or verify the bump seeds. This creates a potential vulnerability where the bump could be manipulated if the derivation process changes.",
    "file_path": "shielded_pool_program/src/instructions/deposit.rs",
    "line_number": 0,
    "remediation": "Store the canonical bump values in the state account data and verify them in the deposit instruction using seeds + stored_bump instead of re-deriving."
  },
  {
    "title": "PDA Bump Seed Not Stored/Verified in Withdraw Instruction",
    "severity": "Medium",
    "description": "The withdraw instruction verifies the state and vault PDAs by re-deriving them but does not store or verify the bump seeds. Additionally, the nullifier PDA derivation uses find_program_address without bump verification.",
    "file_path": "shielded_pool_program/src/instructions/withdraw.rs",
    "line_number": 0,
    "remediation": "Store the canonical bump values for state, vault, and nullifier PDAs in the state account data and verify them in the withdraw instruction using seeds + stored_bump instead of re-deriving."
  },
  {
    "title": "Missing Root History Validation in Withdraw",
    "severity": "High",
    "description": "The withdraw instruction only checks if the submitted root exists in the state's root history but does not validate that the root is recent or prevent replay attacks with old roots.",
    "file_path": "shielded_pool_program/src/instructions/withdraw.rs",
    "line_number": 0,
    "remediation": "Implement a mechanism to track which roots have been used for withdrawals and reject roots that are too old or have already been used. Consider adding a timestamp or sequence number to root entries."
  },
  {
    "title": "Insufficient Nullifier Validation",
    "severity": "High",
    "description": "The nullifier validation only checks if the nullifier account has lamports > 0, but does not verify the nullifier's content matches the submitted nullifier from the proof, creating a potential double-spend vulnerability.",
    "file_path": "shielded_pool_program/src/instructions/withdraw.rs",
    "line_number": 0,
    "remediation": "Store the actual nullifier value in the nullifier account data and verify it matches the submitted nullifier from the proof before checking the lamports status."
  },
  {
    "title": "Recipient Address Encoding Assumption",
    "severity": "Medium",
    "description": "The withdraw instruction assumes a specific recipient address encoding format (copying bytes 0-30 to positions 2-32) without proper validation, which could lead to incorrect recipient validation.",
    "file_path": "shielded_pool_program/src/instructions/withdraw.rs",
    "line_number": 0,
    "remediation": "Implement a clear and documented recipient encoding scheme with proper validation, or use a more robust method for recipient verification that doesn't rely on byte position assumptions."
  }
]