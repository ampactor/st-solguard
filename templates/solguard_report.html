<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SolGuard — Ecosystem Intelligence Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        solana: { purple: '#9945FF', green: '#14F195' }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; }
        .gradient-text {
            background: linear-gradient(135deg, #9945FF, #14F195);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        details > summary { cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        details > summary::marker { display: none; content: ""; }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">
    <header class="border-b border-gray-800 px-6 py-4">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold gradient-text">SolGuard</h1>
                <p class="text-gray-400 text-sm">Autonomous Solana Ecosystem Intelligence</p>
            </div>
            <div class="text-right text-sm text-gray-500">
                <p>Generated: {{ generated_at }}</p>
                <p>{{ narrative_count }} narratives | {{ finding_count }} findings across {{ repo_count }} repos</p>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-6 py-8 space-y-12">
        <!-- Stats -->
        <div class="grid grid-cols-4 gap-4">
            <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
                <p class="text-3xl font-bold text-solana-green">{{ narrative_count }}</p>
                <p class="text-gray-400 text-sm">Emerging Narratives</p>
            </div>
            <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
                <p class="text-3xl font-bold text-blue-400">{{ repo_count }}</p>
                <p class="text-gray-400 text-sm">Repos Scanned</p>
            </div>
            <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
                <p class="text-3xl font-bold text-red-400">{{ critical_count }}</p>
                <p class="text-gray-400 text-sm">Critical/High Findings</p>
            </div>
            <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
                <p class="text-3xl font-bold text-yellow-400">{{ finding_count }}</p>
                <p class="text-gray-400 text-sm">Total Findings</p>
            </div>
        </div>

        <!-- Executive Summary -->
        {% if narrative_count > 0 && finding_count > 0 %}
        <div class="bg-yellow-900/20 border border-yellow-800 rounded-lg p-4">
            <h3 class="text-yellow-400 font-semibold mb-2">Ecosystem Risk Map</h3>
            <p class="text-gray-300 text-sm">SolGuard detected <strong>{{ narrative_count }}</strong> growth narratives and scanned <strong>{{ repo_count }}</strong> repos from those emerging sectors. Found <strong>{{ finding_count }}</strong> vulnerability patterns — {{ critical_count }} at Critical/High severity.{% if has_validation %} Adversarial validation confirmed <strong>{{ confirmed_count }}</strong> findings and disputed <strong>{{ disputed_count }}</strong>.{% endif %} Repos in fast-growing sectors often ship faster than they audit.</p>
        </div>
        {% endif %}

        <!-- Narratives with linked findings -->
        <section>
            <h2 class="text-xl font-bold mb-6 text-gray-200">Narrative Risk Analysis</h2>
            {% if narratives.is_empty() %}
            <p class="text-gray-500">No narratives detected yet. Run with live API keys to populate.</p>
            {% else %}
            <div class="space-y-6">
                {% for n in narratives %}
                <div class="bg-gray-900 rounded-lg border border-gray-800 overflow-hidden">
                    <!-- Narrative header -->
                    <div class="p-5">
                        <div class="flex items-start justify-between">
                            <h3 class="font-semibold text-gray-100">{{ n.title }}</h3>
                            <div class="flex items-center gap-2">
                                {% if n.risk_level != "None" %}
                                <span class="text-xs px-2 py-0.5 rounded border {{ n.risk_class }}">Risk: {{ n.risk_score_fmt }}</span>
                                {% endif %}
                                <span class="text-sm text-gray-400">{{ n.confidence_pct }}%</span>
                            </div>
                        </div>
                        <p class="text-gray-400 text-sm mt-2">{{ n.summary }}</p>
                        <div class="mt-2 flex gap-2">
                            <span class="text-xs bg-gray-800 text-gray-300 px-2 py-0.5 rounded">{{ n.trend }}</span>
                            <span class="text-xs bg-gray-800 text-gray-300 px-2 py-0.5 rounded">{{ n.repo_count }} repos</span>
                            {% if n.finding_count > 0 %}
                            <span class="text-xs bg-red-900/30 text-red-400 px-2 py-0.5 rounded">
                                {{ n.finding_count }} findings
                            </span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Linked findings -->
                    {% if !n.linked_findings.is_empty() %}
                    <div class="border-t border-gray-800 bg-gray-950/50 px-5 py-3">
                        <p class="text-xs text-gray-500 mb-3 uppercase tracking-wider">Linked Vulnerabilities</p>
                        <div class="space-y-3">
                            {% for f in n.linked_findings %}
                            <div class="bg-gray-900/50 rounded p-3 border border-gray-800/50">
                                <div class="flex items-start justify-between">
                                    <span class="text-sm text-gray-200 font-medium">{{ f.title }}</span>
                                    <div class="flex items-center gap-1.5">
                                        <span class="text-xs {{ f.validation_class }} px-1.5 py-0.5 rounded">{{ f.validation_badge }}</span>
                                        <span class="text-xs font-medium {{ f.severity_class }}">{{ f.severity }}</span>
                                    </div>
                                </div>
                                <p class="text-gray-500 text-xs mt-1">{{ f.description }}</p>
                                <div class="mt-1.5 flex flex-wrap gap-3 text-xs">
                                    <span class="text-gray-500"><span class="text-gray-600">Fix:</span> {{ f.remediation }}</span>
                                </div>
                                <div class="mt-1 flex items-center gap-3 text-xs text-gray-600">
                                    <span>{{ f.repo }}</span>
                                    <span>{{ f.file_location }}</span>
                                </div>
                                {% if !f.validation_reasoning.is_empty() %}
                                <details class="mt-1">
                                    <summary class="text-xs text-gray-600 hover:text-gray-500">Validation reasoning</summary>
                                    <p class="text-xs text-gray-500 mt-1">{{ f.validation_reasoning }}</p>
                                </details>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </section>

        <!-- Security Summary -->
        <section>
            <h2 class="text-xl font-bold mb-6 text-gray-200">Security Summary</h2>

            <!-- Severity Breakdown -->
            <div class="grid grid-cols-5 gap-3 mb-6">
                <div class="bg-red-900/20 border border-red-800/50 rounded-lg p-3 text-center">
                    <p class="text-2xl font-bold text-red-500">{{ severity_critical }}</p>
                    <p class="text-gray-400 text-xs">Critical</p>
                </div>
                <div class="bg-orange-900/20 border border-orange-800/50 rounded-lg p-3 text-center">
                    <p class="text-2xl font-bold text-orange-400">{{ severity_high }}</p>
                    <p class="text-gray-400 text-xs">High</p>
                </div>
                <div class="bg-yellow-900/20 border border-yellow-800/50 rounded-lg p-3 text-center">
                    <p class="text-2xl font-bold text-yellow-400">{{ severity_medium }}</p>
                    <p class="text-gray-400 text-xs">Medium</p>
                </div>
                <div class="bg-blue-900/20 border border-blue-800/50 rounded-lg p-3 text-center">
                    <p class="text-2xl font-bold text-blue-400">{{ severity_low }}</p>
                    <p class="text-gray-400 text-xs">Low</p>
                </div>
                <div class="bg-gray-800/50 border border-gray-700/50 rounded-lg p-3 text-center">
                    <p class="text-2xl font-bold text-gray-400">{{ severity_info }}</p>
                    <p class="text-gray-400 text-xs">Info</p>
                </div>
            </div>

            <!-- Findings by Repo -->
            {% if !repo_summaries.is_empty() %}
            <div class="overflow-x-auto mb-8">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-gray-800 text-gray-400">
                            <th class="text-left py-2 px-3">Repository</th>
                            <th class="text-center py-2 px-3">Critical</th>
                            <th class="text-center py-2 px-3">High</th>
                            <th class="text-center py-2 px-3">Medium</th>
                            <th class="text-center py-2 px-3">Low</th>
                            <th class="text-center py-2 px-3">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in repo_summaries %}
                        <tr class="border-b border-gray-800/50 hover:bg-gray-900/50">
                            <td class="py-2 px-3 text-gray-200 font-medium">{{ r.name }}</td>
                            <td class="py-2 px-3 text-center {% if r.critical > 0 %}text-red-500 font-bold{% else %}text-gray-600{% endif %}">{{ r.critical }}</td>
                            <td class="py-2 px-3 text-center {% if r.high > 0 %}text-orange-400 font-bold{% else %}text-gray-600{% endif %}">{{ r.high }}</td>
                            <td class="py-2 px-3 text-center {% if r.medium > 0 %}text-yellow-400{% else %}text-gray-600{% endif %}">{{ r.medium }}</td>
                            <td class="py-2 px-3 text-center text-gray-500">{{ r.low }}</td>
                            <td class="py-2 px-3 text-center text-gray-300 font-medium">{{ r.total }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </section>

        <!-- Orphan Findings -->
        {% if !orphan_findings.is_empty() %}
        <section>
            <details>
                <summary class="text-xl font-bold mb-6 text-gray-200 flex items-center gap-2">
                    <span class="text-sm bg-gray-800 px-2 py-1 rounded">+{{ orphan_count }}</span>
                    Unlinked Findings
                </summary>
                <p class="text-gray-500 text-sm mb-4">Findings not associated with any detected narrative.</p>
                <div class="space-y-3 mt-4">
                    {% for f in orphan_findings %}
                    <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-800/50">
                        <div class="flex items-start justify-between">
                            <span class="text-sm text-gray-200">{{ f.title }}</span>
                            <div class="flex items-center gap-1.5">
                                <span class="text-xs {{ f.validation_class }} px-1.5 py-0.5 rounded">{{ f.validation_badge }}</span>
                                <span class="text-xs {{ f.severity_class }}">{{ f.severity }}</span>
                            </div>
                        </div>
                        <p class="text-gray-500 text-xs mt-1">{{ f.description }}</p>
                        <div class="mt-1 flex items-center gap-3 text-xs text-gray-600">
                            <span>{{ f.repo }}</span>
                            <span>{{ f.file_location }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </details>
        </section>
        {% endif %}

        <!-- Methodology -->
        <section>
            <details>
                <summary class="text-xl font-bold text-gray-200">Methodology</summary>
                <div class="mt-4 text-sm text-gray-400 space-y-3">
                    <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
                        <h4 class="text-gray-300 font-medium mb-2">Signal Collection</h4>
                        <p>Parallel collection from GitHub API (new Solana repos, star velocity), Solana RPC (TPS, program activity), blog scraping (Helius, Jito, Marinade), and DeFiLlama (TVL, protocol rankings). Signals aggregated by category with cross-source validation.</p>
                    </div>
                    <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
                        <h4 class="text-gray-300 font-medium mb-2">Narrative Synthesis</h4>
                        <p>LLM identifies growth narratives from aggregated signals, assigning confidence scores and linking to active repositories. Narrative confidence drives scan budget allocation.</p>
                    </div>
                    <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
                        <h4 class="text-gray-300 font-medium mb-2">Security Scanning</h4>
                        <p>Static analysis: 10 regex + 3 AST vulnerability patterns (SOL-001..010, AST-001..003). Deep review: multi-turn LLM agent investigates trust boundaries, fund flows, and state transitions with protocol-specific focus areas informed by the narrative context.</p>
                    </div>
                    <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
                        <h4 class="text-gray-300 font-medium mb-2">Adversarial Validation</h4>
                        <p>A separate LLM pass attempts to disprove each finding — reading cited code paths, checking for mitigations, and verifying attack reachability. Findings are classified as Confirmed, Disputed (severity downgraded), or Dismissed (removed).</p>
                    </div>
                    <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
                        <h4 class="text-gray-300 font-medium mb-2">Cross-Reference & Risk Scoring</h4>
                        <p>Deterministic risk scoring per narrative: <code class="text-gray-300">risk = sum(severity_weight * validation_multiplier * narrative_confidence)</code>. Severity weights: Critical=10, High=5, Medium=2, Low=0.5. Validation multipliers: Confirmed=1.0, Disputed=0.5, Unvalidated=0.7.</p>
                    </div>
                </div>
            </details>
        </section>
    </main>

    <footer class="border-t border-gray-800 px-6 py-4 mt-12">
        <div class="max-w-6xl mx-auto text-center text-gray-600 text-sm">
            <p>Generated by <span class="gradient-text font-semibold">SolGuard</span> — autonomous Solana ecosystem intelligence</p>
            <p class="mt-1">Pipeline: signal collection → narrative synthesis → narrative-informed scanning → adversarial validation → cross-referenced risk scoring</p>
        </div>
    </footer>
</body>
</html>
